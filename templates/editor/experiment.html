{% extends 'base.html' %}
{% load static %}

{% block meta %}
<link rel="styleshet" href="{% static 'css/experiment.css' %}">
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
{% endblock meta %}

{% block content %}
<!-- Pass in puzzle json from Django template context -->
{{ puzzle|json_script:"puzzle-data" }}




<div id="editor-app">
  <div class="grid-container">
  <div class='grid' :style="gridStyle" @keyup="keyhandle($event)">
    <x-cell v-for="n in length" :idx='n-1' :input-area="inputArea" :active-cell="activeCell" :id="'cell'+n"
      @x-clicked="handleClick">
      <div slot="number" class="number" ><span v-if="numbers[n-1] !== 0">[[ numbers[n-1] ]]</span></div>
      <div slot="entry" class="entry">[[ grid[n-1] ]]</div>
      ]]
    </x-cell>
  </div>
</div>
</div>


<script>
  // get json string store it in a variable
  var puzzleData = JSON.parse(document.querySelector("#puzzle-data").textContent);


  Vue.component("x-cell", {
    template: `
  <div class="cell" :class="{active: isActive, black: isBlack}" @click="clicked">
    <slot name="number"></slot>
    <slot name="entry"></slot>
  </div>`,
    props: ["idx", "activeCell", "inputArea"],
    data: function () {
      return {
        test: 1
      };
    },
    computed: {
      isActive() {
        return this.idx === this.activeCell;
      },
      currentInput() {
        return this.idx === this.inputArea;
      }
    },
    methods: {
      clicked() {
        console.log([this.idx, this.activeCell]);
        this.$emit("x-clicked", this.idx);
      }
    }
  });

  const editor = new Vue({
    el: "#editor-app",
    delimiters: ["[[", "]]"],
    data: {
      grid: puzzleData.grid,
      numbers: puzzleData.gridnums,
      across: puzzleData.clues.across,
      down: puzzleData.clues.down,
      rowN: puzzleData.size.rows,
      colN: puzzleData.size.cols,
      activeCell: 0,
      isVertical: false,
      inputArea: 0
    },
    computed: {
      length() {
        return this.rowN * this.colN;
      },
      testArr() {
        if (this.grid[0] === "CCC") {
          return [1, 2, 3];
        }
        return ["a", "b", "c"];
      },
      gridStyle() {
        return {
          display: 'grid',
          'grid-template-columns': `repeat(${this.colN}, 1fr [col-start])`,
          'grid-auto-rows': '1fr'
        }
      }
    },
    methods: {
      handleClick(idx) {
        console.log(idx);
        this.activeCell = idx;
        //this.updateGrid(idx, "CCC")
      },

      updateGrid(idx, value) {
        this.grid.splice(idx , 1, value);
      },

      keyhandle(event) {
        //console.log(event.key)
        console.log(this.activeCell)
        this.updateGrid(this.activeCell, event.key)
        this.nextCell()
      },

      nextCell(){
        if (!this.isVertical){
          this.activeCell = (this.activeCell+1) % (this.length)
        }
        else {
          this.activeCell = (this.activeCell+this.colN) % (this.length)
        }
      }
    },
    created: function () {
      window.addEventListener('keypress', this.keyhandle)
    }
  });

</script>

{% endblock content %}